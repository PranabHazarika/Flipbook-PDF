name: Auto Publish PDF Flipbook to WordPress

on:
  push:
    paths:
      - '**/*.pdf'
  workflow_dispatch:

jobs:
  post_to_wordpress:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Set up job
        run: echo "Starting workflow"

      - name: üîÑ Checkout Repository
        uses: actions/checkout@v3

      - name: üì• Install jq
        run: sudo apt-get install jq -y

      - name: üîç Detect PDF Upload
        id: pdf_check
        run: |
          echo "Checking for new PDFs..."
          MODIFIED_PDF=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep ".pdf$" | head -n 1 || true)
          echo "Found PDF: $MODIFIED_PDF"
          echo "pdf_file=$MODIFIED_PDF" >> $GITHUB_OUTPUT

      - name: üö´ Exit if No PDF
        if: steps.pdf_check.outputs.pdf_file == ''
        run: |
          echo "‚ùå No new PDF uploaded. Skipping post."
          exit 0

      - name: üìù Create WordPress Post
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        run: |
          FILE_NAME=$(basename "${{ steps.pdf_check.outputs.pdf_file }}")
          POST_TITLE="${FILE_NAME%.pdf}"
          POST_CONTENT="<p>Check out our latest flipbook: <strong>${POST_TITLE}</strong></p><p><a href='${{ secrets.WP_SITE_URL }}/wp-content/uploads/${FILE_NAME}' target='_blank'>üìò Read Flipbook</a></p>"

          echo "üßæ Creating post: $POST_TITLE"

          RESPONSE=$(curl -s -X POST "${WP_SITE_URL}/wp-json/wp/v2/posts" \
            -u "${WP_USERNAME}:${WP_APP_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
{
  "title": "${POST_TITLE}",
  "content": "${POST_CONTENT}",
  "status": "publish",
  "categories": [37]  # Replace with your actual category ID for "Flipbook-Personal Development"
}
EOF
)

          echo "ü™µ WordPress Response:"
          echo "$RESPONSE"

      - name: ‚úÖ Done
        run: echo "‚úÖ Flipbook published to WordPress."
