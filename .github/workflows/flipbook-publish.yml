name: Auto Publish Flipbook to WordPress

on:
  push:
    paths:
      - '**/*.pdf'

jobs:
  post_to_wordpress:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout your repo
      - name: Checkout Repo
        uses: actions/checkout@v3

      # 2) Install PDF + image tools
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y poppler-utils imagemagick jq

      # 3) Detect which PDF was added/changed
      - name: Detect PDF Upload
        id: extract
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          # try diff-based detection
          PDF=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
                | grep -E '\.pdf$' | head -n1)
          # fallback to head_commit.added
          if [ -z "$PDF" ]; then
            PDF=$(jq -r '.head_commit.added[]' "$GITHUB_EVENT_PATH" \
                  | grep -E '\.pdf$' | head -n1)
          fi
          # exit if nothing found
          if [ -z "$PDF" ]; then
            echo "No PDF detected; exiting."
            exit 0
          fi
          echo "pdf_file=$PDF"    >> $GITHUB_ENV
          echo "title=$(basename "$PDF" .pdf)" >> $GITHUB_ENV
          echo "raw_url=https://raw.githubusercontent.com/${{ github.repository }}/main/$PDF" >> $GITHUB_ENV

      # 4) Exit early if no PDF
      - name: Exit if no PDF
        run: |
          if [ -z "$pdf_file" ]; then
            exit 0
          fi

      # 5) Generate a thumbnail from page 1
      - name: Generate PDF Thumbnail
        run: |
          mkdir -p thumbnails
          pdftoppm "$pdf_file" -jpeg -f 1 -singlefile \
            | convert - -resize 400x600 thumbnails/preview.jpg

      # 6) Upload thumbnail to WordPress â†’ capture media ID
      - name: Upload Thumbnail to WordPress
        id: upload_thumb
        run: |
          RESP=$(curl -s -X POST "${{ secrets.WP_SITE_URL }}/wp-json/wp/v2/media" \
            -u "${{ secrets.WP_USER }}:${{ secrets.WP_APP_PASSWORD }}" \
            -H "Content-Disposition: attachment; filename=preview.jpg" \
            -H "Content-Type: image/jpeg" \
            --data-binary "@thumbnails/preview.jpg")
          echo "media_id=$(echo "$RESP" | jq -r '.id')" >> $GITHUB_ENV

      # 7) Create the WordPress post (static excerpt, download disabled)
      - name: Create WordPress Post
        run: |
          curl -s -X POST "${{ secrets.WP_SITE_URL }}/wp-json/wp/v2/posts" \
            -u "${{ secrets.WP_USER }}:${{ secrets.WP_APP_PASSWORD }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "'"${{ env.title }}"'",
              "status": "publish",
              "excerpt": "This is a flipbook from the Personal Development series.",
              "content": "[dflip url=\\"'"${{ env.raw_url }}"'\\" download=\\"false\\"]",
              "categories": [37],
              "featured_media": '"${{ env.media_id }}"'
            }'
